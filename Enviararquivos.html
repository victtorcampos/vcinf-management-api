<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Sefaz - Responsivo</title>
    <link
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      .container {
        margin-top: 40px;
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h2 {
        font-size: 1.75rem;
        color: #007bff;
        font-weight: bold;
      }
      .progress {
        margin-top: 20px;
      }
      .linha-vermelha {
        color: #dc3545;
      }
      /* Responsividade */
      @media (max-width: 768px) {
        .table th,
        .table td {
          font-size: 0.85rem;
        }
        h2 {
          font-size: 1.5rem;
        }
      }
      /* Barra de progresso */
      .progress-bar {
        transition: width 0.6s ease;
      }
      /* Estilo dos botões */
      button[type="submit"] {
        background-color: #007bff;
        border-color: #007bff;
        padding: 10px 15px;
      }
      button[type="submit"]:hover {
        background-color: #0056b3;
      }

      table {
        font-size: 11px;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h2>Compara relatório Sefaz-MT com arquivo XML(s)</h2>
      <form id="uploadForm">
        <div class="form-group">
          <label for="periodo">Período:</label>
          <input type="month" class="form-control" id="periodo" required />
        </div>
        <div class="form-group">
          <label for="tipoDoc">Tipo de Documento:</label>
          <select class="form-control" id="tipoDoc" required>
            <option value="NFCE">NFCE</option>
            <option value="NFE">NFE</option>
            <option value="CTE">CTE</option>
            <option value="NFSE">NFSE</option>
          </select>
        </div>
        <div class="form-group">
          <label for="fileExcelZip">Arquivo Excel (zip):</label>
          <input
            type="file"
            class="form-control-file"
            id="fileExcelZip"
            accept=".zip"
            required
          />
        </div>
        <div class="form-group">
          <label for="fileXmlZip">Arquivo XML (zip):</label>
          <input
            type="file"
            class="form-control-file"
            id="fileXmlZip"
            accept=".zip"
            required
          />
        </div>
        <button type="submit" class="btn btn-primary btn-block">Enviar</button>
      </form>

      <!-- Barra de progresso -->
      <div class="progress">
        <div
          class="progress-bar"
          role="progressbar"
          style="width: 0%"
          aria-valuenow="0"
          aria-valuemin="0"
          aria-valuemax="100"
        ></div>
      </div>

      <div id="resultado" class="mt-4"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
      let dadosFiltrados = [];
      let notasOriginais = [];
      let nome, inscricao, cnpj; // Variáveis globais para armazenar os dados principais

      $("#uploadForm").submit(function (e) {
        e.preventDefault();
        const periodo = $("#periodo").val();
        const tipoDoc = $("#tipoDoc").val();
        const fileExcelZip = document.getElementById("fileExcelZip").files[0];
        const fileXmlZip = document.getElementById("fileXmlZip").files[0];

        if (fileExcelZip && fileXmlZip) {
          // Progress bar logic
          $(".progress-bar")
            .css("width", "50%")
            .attr("aria-valuenow", 50)
            .text("Carregando...");

          const formData = new FormData();
          formData.append(
            "operations",
            JSON.stringify({
              query: `
                    mutation($periodo: String!, $tipoDoc: TipoDoc!, $fileExcelZip: Upload!, $fileXmlZip: Upload!) {
                        resultado : getExcelSefaz(data: {
                            periodo: $periodo,
                            tipoDoc: $tipoDoc,
                            fileExcelZip: $fileExcelZip,
                            fileXmlZip: $fileXmlZip
                        }) {
                            nome
                            inscricao
                            cnpj
                            notas {
                                dataEmissao
                                serie
                                numero
                                chave
                                protocolo
                                dataAutorizacao
                                situacao
                                valor
                                xml
                            }
                        }
                    }
                    `,
              variables: {
                periodo: periodo,
                tipoDoc: tipoDoc,
                fileExcelZip: null,
                fileXmlZip: null,
              },
            })
          );
          formData.append(
            "map",
            JSON.stringify({
              0: ["variables.fileExcelZip"],
              1: ["variables.fileXmlZip"],
            })
          );
          formData.append("0", fileExcelZip);
          formData.append("1", fileXmlZip);

          $.ajax({
            url: "http://localhost:4000/graphql",
            method: "POST",
            processData: false,
            contentType: false,
            data: formData,
            headers: {
              Authorization: "Bearer das1d2a3sd123",
            },
            success: function (response) {
              $(".progress-bar")
                .css("width", "100%")
                .attr("aria-valuenow", 100)
                .text("Concluído");

              // Se o upload for bem-sucedido, apaga o formulário e exibe os dados
              $("#uploadForm").remove();

              // Armazena os dados recebidos
              notasOriginais = response.data.resultado.notas;
              nome = response.data.resultado.nome;
              inscricao = response.data.resultado.inscricao;
              cnpj = response.data.resultado.cnpj;

              renderizarTabela(response.data.resultado, "todos");
            },
            error: function (xhr, status, error) {
              console.error("Error:", error);
              $(".progress-bar")
                .css("width", "100%")
                .attr("aria-valuenow", 100)
                .text("Erro no envio");
            },
          });
        }
      });

      function formatarData(dataISO) {
        const data = new Date(dataISO);
        return data.toLocaleString("pt-BR", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function formatarValorReal(valor) {
        return new Intl.NumberFormat("pt-BR", {
          style: "currency",
          currency: "BRL",
        }).format(valor);
      }

      // Filtro para notas
      function aplicarFiltro(tipoFiltro) {
        switch (tipoFiltro) {
          case "true":
            dadosFiltrados = notasOriginais.filter((nota) => nota.xml === true);
            break;
          case "false":
            dadosFiltrados = notasOriginais.filter(
              (nota) => nota.xml === false
            );
            break;
          case "cancelada":
            dadosFiltrados = notasOriginais.filter(
              (nota) => nota.situacao === "Cancelada"
            );
            break;
          case "autorizadaForaPrazo":
            dadosFiltrados = notasOriginais.filter(
              (nota) => nota.situacao === "Autorizada Fora Prazo"
            );
            break;
          case "canceladaForaPrazo":
            dadosFiltrados = notasOriginais.filter(
              (nota) => nota.situacao === "Cancelada Fora Prazo"
            );
            break;
          default:
            dadosFiltrados = notasOriginais;
        }
        // Chama renderizarTabela passando também nome, inscrição, e CNPJ
        renderizarTabela({ notas: dadosFiltrados, nome, inscricao, cnpj });
      }

      // Função para renderizar a tabela com os dados filtrados
      function renderizarTabela(dados, filtro = "todos") {
        const { nome, inscricao, cnpj, notas } = dados;

        const filtroHtml = `
          <div class="form-group">
            <label for="filtroXml">Filtrar por XML:</label>
            <select id="filtroXml" class="form-control" onchange="aplicarFiltro(this.value)">
              <option value="todos" ${
                filtro === "todos" ? "selected" : ""
              }>Todos</option>
              <option value="true" ${
                filtro === "true" ? "selected" : ""
              }>Somente XML OK</option>
              <option value="false" ${
                filtro === "false" ? "selected" : ""
              }>Somente XML Faltante(s)</option>
              <option value="cancelada" ${
                filtro === "cancelada" ? "selected" : ""
              }>Cancelada</option>
              <option value="autorizadaForaPrazo" ${
                filtro === "autorizadaForaPrazo" ? "selected" : ""
              }>Autorizada Fora Prazo</option>
              <option value="canceladaForaPrazo" ${
                filtro === "canceladaForaPrazo" ? "selected" : ""
              }>Cancelada Fora Prazo</option>
            </select>
          </div>`;

        const tabela = `
          ${filtroHtml}
          <h3>Movimento Fiscal</h3>
          <table class="table table-bordered table-sm">
              <thead>
                  <tr>
                      <th>Razão Social</th>
                      <th>Inscrição</th>
                      <th>CNPJ</th>
                  </tr>
              </thead>
              <tbody>
                  <tr>
                      <td>${nome}</td>
                      <td>${inscricao}</td>
                      <td>${cnpj}</td>
                  </tr>
              </tbody>
          </table>
          <h3>Notas</h3>
          <table class="table table-bordered">
              <thead>
                  <tr>
                      <th>Data de Emissão</th>
                      <th>Série</th>
                      <th>Número</th>
                      <th>Chave</th>
                      <th>Protocolo</th>
                      <th>Data de Autorização</th>
                      <th>Situação</th>
                      <th>Valor</th>
                      <th>XML</th>
                  </tr>
              </thead>
              <tbody>
                  ${notas
                    .map(
                      (nota) => `
                      <tr class="${nota.xml ? "" : "linha-vermelha"}">
                          <td>${formatarData(nota.dataEmissao)}</td>
                          <td>${nota.serie}</td>
                          <td>${nota.numero}</td>
                          <td>${nota.chave}</td>
                          <td>${nota.protocolo}</td>
                          <td>${formatarData(nota.dataAutorizacao)}</td>
                          <td>${nota.situacao}</td>
                          <td>${formatarValorReal(nota.valor)}</td>
                          <td>${nota.xml ? "Sim" : "Não"}</td>
                      </tr>
                  `
                    )
                    .join("")}
              </tbody>
          </table>
      `;

        // Adicionar a tabela e o filtro à div de resultados
        $("#resultado").html(tabela);
      }
    </script>
  </body>
</html>
