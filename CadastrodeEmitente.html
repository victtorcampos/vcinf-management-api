<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro de Emitente</title>
    <style>
      body {
        font-family: Arial, sans-serif;
      }
      form {
        margin: 20px;
        padding: 20px;
        border: 1px solid #ccc;
        font-size: 11px;
        width: 600px;
      }
      label {
        display: block;
        margin-bottom: 2px;
      }

      input,
      textarea {
        width: 60px;
        padding-top: 1px;
        padding-bottom: 1px;
        padding-right: 7px;
        padding-left: 7px;
        margin-bottom: 2px;
        font-size: 11px;
      }
      button {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
      }
      button:hover {
        background-color: #0056b3;
      }
      .error {
        color: red;
      }
    </style>
  </head>
  <body>
    <h2>Cadastro de Emitente</h2>

    <form id="emitenteForm">
      <label
        >Código Domínio:
        <input type="text" id="cod_dominio" required style="width: 60px"
      /></label>
      <label
        >Nome: <input type="text" id="nome" required style="width: 400px"
      /></label>
      <label
        >Razão Social:
        <input type="text" id="razao_social" style="width: 400px" required
      /></label>
      <label
        >CNPJ: <input type="text" id="cnpj" required style="width: 150px"
      /></label>
      <label
        >Inscrição Estadual (IE):
        <input type="text" id="IE" style="width: 150px" required
      /></label>
      <label
        >Logradouro:
        <input type="text" id="logradouro" style="width: 500px" required
      /></label>
      <label
        >Número: <input type="text" id="nro" style="width: 60px" required
      /></label>
      <label
        >Bairro: <input type="text" id="bairro" style="width: 150px" required
      /></label>
      <label
        >CEP: <input type="text" id="cep" style="width: 100px" required
      /></label>
      <label
        >Nome da Cidade:
        <input type="text" id="nome_cidade" style="width: 250px" required
      /></label>
      <label
        >Código IBGE da Cidade:
        <input type="text" id="codigoIBGEcidade" style="width: 50px" required
      /></label>
      <label
        >Nome do Estado:
        <input type="text" id="nome_estado" style="width: 250px" required
      /></label>
      <label
        >UF: <input type="text" id="uf" style="width: 50px" required
      /></label>
      <label
        >Código IBGE do Estado:
        <input type="text" id="codigoIBGEestado" style="width: 50px" required
      /></label>
      <button type="submit">Enviar</button>
      <div id="responseMessage" class="error"></div>
    </form>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
      $(document).ready(function () {
        $("#emitenteForm").on("submit", function (e) {
          e.preventDefault();

          const formData = {
            cod_dominio: $("#cod_dominio").val(),
            nome: $("#nome").val(),
            razao_social: $("#razao_social").val(),
            cnpj: $("#cnpj").val(),
            ie: $("#IE").val(),
            endereco: {
              logradouro: $("#logradouro").val(),
              nro: $("#nro").val(),
              bairro: $("#bairro").val(),
              cep: $("#cep").val(),
              nome_cidade: $("#nome_cidade").val(),
              codigoIBGEcidade: $("#codigoIBGEcidade").val(),
              nome_estado: $("#nome_estado").val(),
              uf: $("#uf").val(),
              codigoIBGEestado: $("#codigoIBGEestado").val(),
            },
          };

          const enderecoGraphQL = `{
            logradouro: "${formData.endereco.logradouro}",
            nro: "${formData.endereco.nro}",
            bairro: "${formData.endereco.bairro}",
            cep: "${formData.endereco.cep}",
            nome_cidade: "${formData.endereco.nome_cidade}",
            codigoIBGEcidade: "${formData.endereco.codigoIBGEcidade}",
            nome_estado: "${formData.endereco.nome_estado}",
            uf: "${formData.endereco.uf}",
            codigoIBGEestado: "${formData.endereco.codigoIBGEestado}"
          }`;

          const mutation = `mutation {
            createEmitente(
              data: {
                cod_dominio: "${formData.cod_dominio}",
                nome: "${formData.nome}",
                razao_social: "${formData.razao_social}",
                cnpj: "${formData.cnpj}",
                ie: "${formData.ie}",
                enderecos: [${enderecoGraphQL}]
              }
            ) {
              success
              data {
                id
                enderecos {
                  id
                }
              }
              error {
                code
                message
              }
            }
          }`;

          console.log(
            JSON.stringify({
              query: mutation,
            })
          );

          $.ajax({
            url: "http://localhost:4000",
            method: "POST",
            contentType: "application/json",
            headers: {
              Authorization:
                "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2NmNlNmM2MWFhNzBlNzBmNzYzZTY4OTMiLCJyb2xlIjoiQURNSU4iLCJjb250YWRvcklkIjoiNjZjZmU5YTRmMDgwMTA2Yjc0OTEwNTgwIiwiaWF0IjoxNzI1ODM1NTE1LCJleHAiOjE3MjU5MjE5MTV9.yLPu6L7q5gazapOIas0afXlepH4x8VpiwcRl3kHLM0o",
            },
            data: JSON.stringify({
              query: mutation,
            }),
            success: function (response) {
              if (response.data.createEmitente.success) {
                $("#responseMessage")
                  .html("Cadastro realizado com sucesso!")
                  .css("color", "green");
              } else {
                $("#responseMessage").html(
                  response.data.createEmitente.error.message
                );
              }
            },
            error: function (xhr, status, error) {
              $("#responseMessage").html("Erro ao enviar os dados: " + error);
            },
          });
        });

        $("#cnpj").on("blur", function () {
          var cnpj = $(this)
            .val()
            .replace(/[^0-9]/g, ""); // Remove caracteres não numéricos
          if (cnpj.length === 14) {
            // Verifica se o CNPJ tem 14 dígitos
            $.ajax({
              url: "http://localhost:4000",
              method: "POST",
              contentType: "application/json",
              headers: {
                Authorization:
                  "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2NmNlNmM2MWFhNzBlNzBmNzYzZTY4OTMiLCJyb2xlIjoiQURNSU4iLCJjb250YWRvcklkIjoiNjZjZmU5YTRmMDgwMTA2Yjc0OTEwNTgwIiwiaWF0IjoxNzI1ODM1NTE1LCJleHAiOjE3MjU5MjE5MTV9.yLPu6L7q5gazapOIas0afXlepH4x8VpiwcRl3kHLM0o",
              },
              data: JSON.stringify({
                query: `mutation {
            conslutaReceitaws(cnpj: "${cnpj}") {
              success
              data {
                nome
                razao_social
                cnpj
                enderecos {
                  logradouro
                  nro
                  bairro
                  cep
                  nome_cidade
                  codigoIBGEcidade
                  nome_estado
                  uf
                  codigoIBGEestado
                }
              }
              error {
                code
                message
              }
            }
          }`,
              }),
              success: function (response) {
                if (response.data.conslutaReceitaws.success) {
                  const data = response.data.conslutaReceitaws.data;
                  $("#nome").val(data.nome);
                  $("#razao_social").val(data.razao_social);
                  $("#logradouro").val(data.enderecos[0].logradouro);
                  $("#nro").val(data.enderecos[0].nro);
                  $("#bairro").val(data.enderecos[0].bairro);
                  $("#cep").val(data.enderecos[0].cep);
                  $("#nome_cidade").val(data.enderecos[0].nome_cidade);
                  $("#codigoIBGEcidade").val(
                    data.enderecos[0].codigoIBGEcidade
                  );
                  $("#nome_estado").val(data.enderecos[0].nome_estado);
                  $("#uf").val(data.enderecos[0].uf);
                  $("#codigoIBGEestado").val(
                    data.enderecos[0].codigoIBGEestado
                  );
                  $("#responseMessage").html("").css("color", "green");
                } else {
                  $("#responseMessage")
                    .html(response.data.conslutaReceitaws.error.message)
                    .css("color", "red");
                }
              },
              error: function (xhr, status, error) {
                $("#responseMessage")
                  .html("Erro ao buscar os dados: " + error)
                  .css("color", "red");
              },
            });
          }
        });
      });
    </script>
  </body>
</html>
